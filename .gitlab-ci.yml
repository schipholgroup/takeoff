stages:
- test
- deploy

services:
- docker:dind

lint:
  image: python:3.7
  stage: test
  script:
  - python setup.py flake8

test:
  image: python:3.7
  stage: test
  script:
  - python setup.py test


hadolint:
  image:  hadolint/hadolint:latest-debian
  stage: test
  script:
  - hadolint Dockerfile

runway:
  image: docker:latest
  stage: deploy
  script:
  - env > .env
  - export DOCKER_HOST="tcp://localhost:2375"
  - docker build -t runway:latest -f Dockerfile .
  - version=$(docker run --env-file .env -v `echo $PWD`:/root runway:latest bash -c "cd /root && get_version")

  - docker login --username $jfrog_username --password $jfrog_password schipholsdh-docker.jfrog.io
  - docker tag runway:latest schipholsdh-docker.jfrog.io/runway:${version}-python
  - docker push schipholsdh-docker.jfrog.io/runway:${version}
