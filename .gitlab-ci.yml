stages:
- test
- deploy

services:
- docker:dind

lint:
  image: python:3.7
  stage: test
  script:
  - python setup.py flake8

test:
  image: python:3.7
  stage: test
  script:
  - python setup.py test

runway:
  image: docker:latest
  stage: deploy
  script:
  - env > .env
  - export DOCKER_HOST="tcp://localhost:2375"
  - docker build -t runway:latest -f Dockerfile .
  - version=$(docker run --env-file .env -v `echo $PWD`:/root runway:latest bash -c "cd /root && get_version")

  - docker login --username ${REGISTRY_USERNAME} --password ${REGISTRY_PASSWORD} ${REGISTRY_LOGIN_SERVER}
  - docker tag runway:latest ${REGISTRY_LOGIN_SERVER}/${TRAVIS_REPO_NAME}:${version}
  - docker push ${REGISTRY_LOGIN_SERVER}/${TRAVIS_REPO_NAME}:${version}
