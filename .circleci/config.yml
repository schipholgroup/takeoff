version: 2.1
orbs:
  codecov: codecov/codecov@1.0.5
jobs:
  lint:
    docker:
      - image: python:3.7
    steps:
      - checkout
      - run: python setup.py lint

  lint_yaml:
    docker:
      - image: giantswarm/yamllint:latest
    steps:
      - checkout
      - run: yamllint -d relaxed .

  lint_black:
    docker:
      - image: python:3.7
    steps:
      - checkout
      - run: pip install black
      - run: black -l 110 --check takeoff

  test:
    docker:
      - image: python:3.7
    steps:
      - checkout
      - run: pip install -e .[test]
      - run: python setup.py test
      - codecov/upload

  takeoff:
    docker:
      - image: docker:latest
    steps:
      - checkout
      - setup_remote_docker:   # (2)
          docker_layer_caching: true # (3)
      - run: docker build -t takeoff:latest -f Dockerfile .
      - run: version=$(docker run --env-file .env -v `echo $PWD`:/src takeoff:latest get_version)
      - run: docker tag takeoff:latest ${REGISTRY_LOGIN_SERVER}/takeoff:${version}
      - run: docker push ${REGISTRY_LOGIN_SERVER}/takeoff:${version}

workflows:
  version: 2.1
  test:
    jobs:
      - lint
      - lint_yaml
      - lint_black
      - test
  deploy:
    jobs:
      - takeoff


#services:
#  - docker:dind
#
#takeoff:
#  image: docker:latest
#  stage: deploy
#  variables:
#    DOCKER_HOST: tcp://localhost:2375
#  before_script:
#    - unset CI_COMMIT_DESCRIPTION CI_COMMIT_MESSAGE # hack to avoid multiline env variables that docker does not like
#    - env | grep -v ^PATH > .env
#    - docker login --username ${REGISTRY_USERNAME} --password ${REGISTRY_PASSWORD} ${REGISTRY_LOGIN_SERVER}
#  script:
#    - docker build -t takeoff:latest -f Dockerfile .
#
#    - version=$(docker run --env-file .env -v `echo $PWD`:/src takeoff:latest get_version)
#    - docker tag takeoff:latest ${REGISTRY_LOGIN_SERVER}/takeoff:${version}
#    - docker push ${REGISTRY_LOGIN_SERVER}/takeoff:${version}
